// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  image     String?
  phone     String?
  role      UserRole @default(CUSTOMER)
  googleId  String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  customer        Customer?
  deliveryPartner DeliveryPartner?
  restaurant      Restaurant?
  sessions        Session[]
  accounts        Account[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// Customer specific data
model Customer {
  id                   String   @id @default(cuid())
  userId               String   @unique
  favoriteRestaurants  String[] // Array of restaurant IDs
  defaultAddressId     String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  addresses Address[]
  orders    Order[]
  reviews   Review[]

  @@map("customers")
}

// Delivery Partner specific data
model DeliveryPartner {
  id                  String        @id @default(cuid())
  userId              String        @unique
  assignedRestaurants String[]      // Array of restaurant IDs
  currentLatitude     Float?
  currentLongitude    Float?
  status              PartnerStatus @default(OFFLINE)
  todayEarnings       Float         @default(0)
  totalEarnings       Float         @default(0)
  rating              Float         @default(0)
  completedDeliveries Int           @default(0)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders          Order[]
  deliveryBatches DeliveryBatch[]

  @@map("delivery_partners")
}

// Restaurant data
model Restaurant {
  id                      String           @id @default(cuid())
  name                    String
  description             String?
  ownerId                 String           @unique
  latitude                Float
  longitude               Float
  address                 String
  phone                   String
  email                   String?
  imageUrl                String?
  cuisineTypes            String[]
  averagePreparationTime  Int              @default(20) // in minutes
  minimumOrderAmount      Float            @default(0)
  deliveryRadius          Float            @default(5) // in km
  commissionRate          Float            @default(0.15) // 15%
  rating                  Float            @default(0)
  totalOrders             Int              @default(0)
  status                  RestaurantStatus @default(ACTIVE)
  operatingHours          Json // Store as JSON: { "monday": { "open": "21:00", "close": "00:00" }, ... }
  assignedDeliveryPartners String[]        // Array of delivery partner IDs
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt

  owner     User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  menuItems MenuItem[]
  orders    Order[]
  reviews   Review[]

  @@map("restaurants")
}

// Menu items
model MenuItem {
  id              String   @id @default(cuid())
  restaurantId    String
  name            String
  description     String?
  price           Float
  originalPrice   Float? // For discount display
  category        String
  preparationTime Int      @default(15) // in minutes
  imageUrl        String?
  dietaryTags     String[] // ["vegetarian", "vegan", "gluten-free", etc.]
  spiceLevel      String? // "mild", "medium", "hot"
  available       Boolean  @default(true)
  featured        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  restaurant Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@map("menu_items")
}

// Address management
model Address {
  id           String      @id @default(cuid())
  customerId   String
  type         AddressType @default(HOME)
  street       String
  city         String
  state        String
  zipCode      String
  latitude     Float?
  longitude    Float?
  landmark     String?
  instructions String?
  isDefault    Boolean     @default(false)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  orders   Order[]

  @@map("addresses")
}

// Orders
model Order {
  id                     String      @id @default(cuid())
  orderNumber            String      @unique
  customerId             String
  restaurantId           String
  deliveryPartnerId      String?
  deliveryAddressId      String
  status                 OrderStatus @default(PLACED)
  subtotal               Float
  deliveryFee            Float       @default(0)
  taxes                  Float       @default(0)
  discountAmount         Float       @default(0)
  totalAmount            Float
  estimatedPreparationTime Int       // in minutes
  estimatedDeliveryTime  DateTime?
  actualDeliveryTime     DateTime?
  verificationCode       String
  paymentId              String?
  paymentStatus          String      @default("pending")
  specialInstructions    String?
  cancelReason           String?
  createdAt              DateTime    @default(now())
  updatedAt              DateTime    @updatedAt

  customer         Customer         @relation(fields: [customerId], references: [id])
  restaurant       Restaurant       @relation(fields: [restaurantId], references: [id])
  deliveryPartner  DeliveryPartner? @relation(fields: [deliveryPartnerId], references: [id])
  deliveryAddress  Address          @relation(fields: [deliveryAddressId], references: [id])
  orderItems       OrderItem[]
  deliveryBatch    DeliveryBatch?   @relation(fields: [deliveryBatchId], references: [id])
  deliveryBatchId  String?
  review           Review?
  orderAnalytics   OrderAnalytics?

  @@map("orders")
}

// Order items
model OrderItem {
  id             String   @id @default(cuid())
  orderId        String
  menuItemId     String
  quantity       Int
  unitPrice      Float
  totalPrice     Float
  customizations Json? // Store customizations as JSON
  createdAt      DateTime @default(now())

  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem MenuItem @relation(fields: [menuItemId], references: [id])

  @@map("order_items")
}

// Delivery batching
model DeliveryBatch {
  id                        String      @id @default(cuid())
  deliveryPartnerId         String
  status                    BatchStatus @default(CREATED)
  pickupLatitude            Float
  pickupLongitude           Float
  estimatedCompletionTime   DateTime?
  actualCompletionTime      DateTime?
  totalDistance             Float?      @default(0)
  optimizedRoute            Json? // Store route as JSON
  createdAt                 DateTime    @default(now())
  updatedAt                 DateTime    @updatedAt

  deliveryPartner DeliveryPartner @relation(fields: [deliveryPartnerId], references: [id])
  orders          Order[]
  deliveryStops   DeliveryStop[]

  @@map("delivery_batches")
}

// Delivery stops
model DeliveryStop {
  id                   String     @id @default(cuid())
  deliveryBatchId      String
  orderId              String     @unique
  latitude             Float
  longitude            Float
  estimatedArrivalTime DateTime?
  actualArrivalTime    DateTime?
  status               StopStatus @default(PENDING)
  sequenceNumber       Int
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  deliveryBatch DeliveryBatch @relation(fields: [deliveryBatchId], references: [id], onDelete: Cascade)

  @@map("delivery_stops")
}

// Reviews and ratings
model Review {
  id           String   @id @default(cuid())
  customerId   String
  restaurantId String
  orderId      String   @unique
  rating       Int // 1-5 stars
  comment      String?
  foodRating   Int? // 1-5 stars
  serviceRating Int? // 1-5 stars
  deliveryRating Int? // 1-5 stars
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  customer   Customer   @relation(fields: [customerId], references: [id])
  restaurant Restaurant @relation(fields: [restaurantId], references: [id])
  order      Order      @relation(fields: [orderId], references: [id])

  @@map("reviews")
}

// Analytics
model OrderAnalytics {
  id                    String   @id @default(cuid())
  orderId               String   @unique
  preparationTime       Int? // actual time taken
  deliveryTime          Int? // actual delivery time
  customerWaitTime      Int? // total wait time
  distanceTraveled      Float?
  deliveryEfficiency    Float? // calculated metric
  customerSatisfaction  Float?
  restaurantPerformance Float?
  createdAt             DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_analytics")
}

// Platform analytics
model PlatformMetrics {
  id                   String   @id @default(cuid())
  date                 DateTime @unique @db.Date
  totalOrders          Int      @default(0)
  totalRevenue         Float    @default(0)
  averageOrderValue    Float    @default(0)
  averageDeliveryTime  Int      @default(0)
  customerAcquisition  Int      @default(0)
  restaurantSignups    Int      @default(0)
  deliveryPartnerSignups Int    @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("platform_metrics")
}

// Enums
enum UserRole {
  CUSTOMER
  DELIVERY_PARTNER
  RESTAURANT_OWNER
  ADMIN
}

enum OrderStatus {
  PLACED
  CONFIRMED
  PREPARING
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum BatchStatus {
  CREATED
  ASSIGNED
  IN_PROGRESS
  COMPLETED
}

enum PartnerStatus {
  AVAILABLE
  BUSY
  OFFLINE
}

enum RestaurantStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AddressType {
  HOME
  WORK
  OTHER
}

enum StopStatus {
  PENDING
  COMPLETED
  SKIPPED
}
