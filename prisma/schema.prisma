generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                  @id @default(cuid())
  email                  String?                 @unique
  name                   String?
  image                  String?
  phone                  String?                 @unique
  role                   UserRole                @default(CUSTOMER)
  googleId               String?                 @unique
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  password               String?
  accounts               Account[]
  customer               Customer?
  deliveryPartner        DeliveryPartner?
  notificationHistory    NotificationHistory[]
  notificationPreference NotificationPreference?
  pushSubscriptions      PushSubscription[]
  restaurant             Restaurant?
  sessions               Session[]
  userActivities         UserActivity[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Customer {
  id                  String    @id @default(cuid())
  userId              String    @unique
  favoriteRestaurants String[]
  defaultAddressId    String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  addresses           Address[]
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders              Order[]
  reviews             Review[]

  @@map("customers")
}

model DeliveryPartner {
  id                  String               @id @default(cuid())
  userId              String               @unique
  assignedRestaurants String[]
  currentLatitude     Float?
  currentLongitude    Float?
  status              PartnerStatus        @default(OFFLINE)
  todayEarnings       Float                @default(0)
  totalEarnings       Float                @default(0)
  rating              Float                @default(0)
  completedDeliveries Int                  @default(0)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  telegramPhone       String?
  telegramChatId      String?
  ratingCount         Int                  @default(0)
  deliveryBatches     DeliveryBatch[]
  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders              Order[]
  performanceMetrics  PerformanceMetrics[]

  @@map("delivery_partners")
}

model Location {
  id          String       @id @default(cuid())
  name        String       @unique
  city        String       @default("Bengaluru")
  state       String       @default("Karnataka")
  country     String       @default("India")
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  restaurants Restaurant[]

  @@map("locations")
}

model Restaurant {
  id                        String               @id @default(cuid())
  name                      String
  ownerId                   String               @unique
  latitude                  Float
  longitude                 Float
  address                   String
  phone                     String
  email                     String?
  imageUrl                  String?
  cuisineTypes              String[]             @default([])
  averagePreparationTime    Int                  @default(20)
  minimumOrderAmount        Float                @default(200)
  deliveryRadius            Float                @default(5)
  commissionRate            Float                @default(0.15)
  rating                    Float                @default(0)
  totalOrders               Int                  @default(0)
  status                    RestaurantStatus     @default(ACTIVE)
  operatingHours            Json
  assignedDeliveryPartners  String[]
  createdAt                 DateTime             @default(now())
  updatedAt                 DateTime             @updatedAt
  ownerName                 String
  aastaPricePercentage      Float                @default(0.10)
  restaurantPricePercentage Float                @default(0.40)
  locationId                String
  pickupExperienceCount     Int                  @default(0)
  pickupExperienceRating    Float                @default(0)
  menuItems                 MenuItem[]
  orders                    Order[]
  performanceMetrics        PerformanceMetrics[]
  location                  Location             @relation(fields: [locationId], references: [id])
  owner                     User                 @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  reviews                   Review[]

  @@map("restaurants")
}

model MenuItem {
  id              String      @id @default(cuid())
  restaurantId    String
  name            String
  description     String?
  price           Float
  originalPrice   Float?
  category        String
  preparationTime Int         @default(15)
  imageUrl        String?
  dietaryTags     String[]
  spiceLevel      String?
  available       Boolean     @default(true)
  featured        Boolean     @default(false)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  stockLeft       Int?
  rating          Float       @default(0)
  ratingCount     Int         @default(0)
  hackOfTheDay    Boolean     @default(false)
  restaurant      Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orderItems      OrderItem[]

  @@map("menu_items")
}

model Address {
  id           String      @id @default(cuid())
  customerId   String
  type         AddressType @default(HOME)
  street       String?
  city         String?
  state        String?
  zipCode      String?
  latitude     Float?
  longitude    Float?
  landmark     String?
  instructions String?
  isDefault    Boolean     @default(false)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  contactPhone String?
  houseNumber  String?
  locality     String?
  customer     Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  orders       Order[]

  @@map("addresses")
}

model Order {
  id                        String           @id @default(cuid())
  orderNumber               String           @unique
  customerId                String
  restaurantId              String
  deliveryPartnerId         String?
  deliveryAddressId         String?
  status                    OrderStatus      @default(PLACED)
  subtotal                  Float
  deliveryFee               Float            @default(0)
  taxes                     Float            @default(0)
  discountAmount            Float            @default(0)
  totalAmount               Float
  estimatedPreparationTime  Int
  estimatedDeliveryTime     DateTime?
  actualDeliveryTime        DateTime?
  verificationCode          String
  paymentStatus             String           @default("pending")
  specialInstructions       String?
  cancelReason              String?
  createdAt                 DateTime         @default(now())
  updatedAt                 DateTime         @updatedAt
  deliveryBatchId           String?
  razorpayOrderId           String?
  deliveryDistance          Float?
  estimatedDeliveryDuration Int?
  orderType                 OrderType        @default(DELIVERY)
  orderAnalytics            OrderAnalytics?
  orderItems                OrderItem[]
  customer                  Customer         @relation(fields: [customerId], references: [id])
  deliveryAddress           Address?         @relation(fields: [deliveryAddressId], references: [id])
  deliveryBatch             DeliveryBatch?   @relation(fields: [deliveryBatchId], references: [id])
  deliveryPartner           DeliveryPartner? @relation(fields: [deliveryPartnerId], references: [id])
  restaurant                Restaurant       @relation(fields: [restaurantId], references: [id])
  payments                  Payment[]
  review                    Review?

  @@map("orders")
}

model Payment {
  id                String    @id @default(cuid())
  orderId           String
  razorpayOrderId   String
  razorpayPaymentId String?   @unique
  amount            Float
  currency          String
  status            String    @default("CREATED")
  paymentMethod     String
  failureReason     String?
  capturedAt        DateTime?
  createdAt         DateTime  @default(now())
  order             Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  refunds           Refund[]

  @@unique([orderId, razorpayOrderId])
  @@map("payments")
}

model Refund {
  id               String    @id @default(cuid())
  paymentId        String
  razorpayRefundId String    @unique
  amount           Float
  currency         String
  status           String    @default("CREATED")
  reason           String?
  processedAt      DateTime?
  createdAt        DateTime  @default(now())
  payment          Payment   @relation(fields: [paymentId], references: [razorpayPaymentId])

  @@map("refunds")
}

model OrderItem {
  id                        String   @id @default(cuid())
  orderId                   String
  menuItemId                String
  quantity                  Int
  unitPrice                 Float
  totalPrice                Float
  customizations            Json?
  createdAt                 DateTime @default(now())
  aastaEarningsPerItem      Float?
  aastaTotalEarnings        Float?
  originalUnitPrice         Float?
  restaurantEarningsPerItem Float?
  restaurantTotalEarnings   Float?
  totalOriginalPrice        Float?
  menuItem                  MenuItem @relation(fields: [menuItemId], references: [id])
  order                     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

model DeliveryBatch {
  id                      String          @id @default(cuid())
  deliveryPartnerId       String
  status                  BatchStatus     @default(CREATED)
  pickupLatitude          Float
  pickupLongitude         Float
  estimatedCompletionTime DateTime?
  actualCompletionTime    DateTime?
  totalDistance           Float?          @default(0)
  optimizedRoute          Json?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  deliveryPartner         DeliveryPartner @relation(fields: [deliveryPartnerId], references: [id])
  deliveryStops           DeliveryStop[]
  orders                  Order[]

  @@map("delivery_batches")
}

model DeliveryStop {
  id                   String        @id @default(cuid())
  deliveryBatchId      String
  orderId              String        @unique
  latitude             Float
  longitude            Float
  estimatedArrivalTime DateTime?
  actualArrivalTime    DateTime?
  status               StopStatus    @default(PENDING)
  sequenceNumber       Int
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  deliveryBatch        DeliveryBatch @relation(fields: [deliveryBatchId], references: [id], onDelete: Cascade)

  @@map("delivery_stops")
}

model Review {
  id             String     @id @default(cuid())
  customerId     String
  restaurantId   String
  orderId        String     @unique
  rating         Int
  comment        String?
  foodRating     Int?
  serviceRating  Int?
  deliveryRating Int?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  customer       Customer   @relation(fields: [customerId], references: [id])
  order          Order      @relation(fields: [orderId], references: [id])
  restaurant     Restaurant @relation(fields: [restaurantId], references: [id])

  @@map("reviews")
}

model OrderAnalytics {
  id                    String   @id @default(cuid())
  orderId               String   @unique
  preparationTime       Int?
  deliveryTime          Int?
  customerWaitTime      Int?
  distanceTraveled      Float?
  deliveryEfficiency    Float?
  customerSatisfaction  Float?
  restaurantPerformance Float?
  createdAt             DateTime @default(now())
  order                 Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_analytics")
}

model PlatformMetrics {
  id                     String   @id @default(cuid())
  date                   DateTime @unique @db.Date
  totalOrders            Int      @default(0)
  totalRevenue           Float    @default(0)
  averageOrderValue      Float    @default(0)
  averageDeliveryTime    Int      @default(0)
  customerAcquisition    Int      @default(0)
  restaurantSignups      Int      @default(0)
  deliveryPartnerSignups Int      @default(0)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  platformRatingCount    Int      @default(0)
  platformRatingSum      Float    @default(0)

  @@map("platform_metrics")
}

model NotificationPreference {
  id                  String                @id @default(cuid())
  userId              String                @unique
  emailEnabled        Boolean               @default(true)
  pushEnabled         Boolean               @default(true)
  smsEnabled          Boolean               @default(false)
  telegramEnabled     Boolean               @default(true)
  orderUpdates        Boolean               @default(true)
  promotions          Boolean               @default(true)
  deliveryAlerts      Boolean               @default(true)
  systemAnnouncements Boolean               @default(true)
  frequency           NotificationFrequency @default(REAL_TIME)
  quietHoursStart     String?
  quietHoursEnd       String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  user                User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model NotificationHistory {
  id        String              @id @default(cuid())
  userId    String
  type      NotificationType
  channel   NotificationChannel
  title     String
  message   String
  data      Json?
  status    NotificationStatus  @default(PENDING)
  sentAt    DateTime?
  readAt    DateTime?
  clickedAt DateTime?
  errorMsg  String?
  createdAt DateTime            @default(now())
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_history")
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String
  p256dh    String
  auth      String
  active    Boolean  @default(true)
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@map("push_subscriptions")
}

model UserActivity {
  id        String   @id @default(cuid())
  userId    String
  sessionId String
  action    String
  page      String?
  data      Json?
  ipAddress String?
  userAgent String?
  duration  Int?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@map("user_activities")
}

model PerformanceMetrics {
  id                     String           @id @default(cuid())
  date                   DateTime         @db.Date
  restaurantId           String?
  deliveryPartnerId      String?
  totalOrders            Int              @default(0)
  completedOrders        Int              @default(0)
  cancelledOrders        Int              @default(0)
  averagePreparationTime Float            @default(0)
  averageDeliveryTime    Float            @default(0)
  customerSatisfaction   Float            @default(0)
  revenue                Float            @default(0)
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
  deliveryPartner        DeliveryPartner? @relation(fields: [deliveryPartnerId], references: [id])
  restaurant             Restaurant?      @relation(fields: [restaurantId], references: [id])

  @@unique([date, restaurantId, deliveryPartnerId])
  @@map("performance_metrics")
}

enum UserRole {
  CUSTOMER
  DELIVERY_PARTNER
  RESTAURANT_OWNER
  ADMIN
}

enum NotificationFrequency {
  REAL_TIME
  HOURLY
  DAILY
  WEEKLY
}

enum NotificationType {
  ORDER_UPDATE
  DELIVERY_ALERT
  PROMOTION
  SYSTEM_ANNOUNCEMENT
  RESTAURANT_NOTIFICATION
}

enum NotificationChannel {
  EMAIL
  PUSH
  SMS
  TELEGRAM
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum OrderStatus {
  PLACED
  CONFIRMED
  PREPARING
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum OrderType {
  DELIVERY
  PICKUP
}

enum BatchStatus {
  CREATED
  ASSIGNED
  IN_PROGRESS
  COMPLETED
}

enum PartnerStatus {
  AVAILABLE
  BUSY
  OFFLINE
}

enum RestaurantStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AddressType {
  HOME
  WORK
  OTHER
}

enum StopStatus {
  PENDING
  COMPLETED
  SKIPPED
}
